name: Deploy to Vercel

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # Ejecutar tests diariamente a las 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          pnpm audit --audit-level=high
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Dependencies scanned for vulnerabilities" >> $GITHUB_STEP_SUMMARY

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: javascript

  test:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type checking
        run: pnpm type-check

      - name: Run linting
        run: pnpm lint

      - name: Run unit tests
        run: pnpm test
        env:
          NEXT_PUBLIC_WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL_STAGING }}
          NODE_ENV: test

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          NEXT_PUBLIC_WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL_STAGING }}
          E2E_BASE_URL: 'http://localhost:3000'

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL_STAGING }}
          NEXT_PUBLIC_APP_ENV: staging

  deploy-staging:
    if: github.ref == 'refs/heads/develop'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          alias-domains: |
            staging.inglesexpress.com
          working-directory: ./
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Run post-deployment checks
        run: |
          sleep 10  # Esperar a que el deployment est√© listo
          curl -f https://staging.inglesexpress.com/api/health || exit 1

      - name: Notify Slack
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Staging deployment completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚úÖ Staging Deployment Completed*\n\n‚Ä¢ Repository: ${{ github.repository }}\n‚Ä¢ Branch: ${{ github.ref }}\n‚Ä¢ Commit: ${{ github.sha }}\n‚Ä¢ Environment: staging\n‚Ä¢ URL: https://staging.inglesexpress.com\n‚Ä¢ Health Check: ‚úÖ Passing"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  deploy-production:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ steps.version.outputs.VERSION }}

      - name: Deploy to Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          alias-domains: |
            inglesexpress.com
            www.inglesexpress.com
          working-directory: ./
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Run post-deployment script
        run: |
          # Esperar a que el deployment est√© activo
          sleep 15

          # Health check
          curl -f https://inglesexpress.com/api/health || exit 1

          # Clear cache
          curl -X POST https://inglesexpress.com/api/cache/clear

          # Generate sitemap
          curl https://inglesexpress.com/api/generate-sitemap

          # Warm up cache for critical pages
          for url in "/" "/niveles" "/precios" "/test-nivel"; do
            curl -s "https://inglesexpress.com$url" > /dev/null
            sleep 1
          done

      - name: Notify deployment success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üöÄ Production deployment completed successfully!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üöÄ Production Deployment Complete*\n\n‚Ä¢ Version: ${{ steps.version.outputs.VERSION }}\n‚Ä¢ Environment: production\n‚Ä¢ URL: https://inglesexpress.com\n‚Ä¢ Health Check: ‚úÖ Passing\n‚Ä¢ Commit: ${{ github.sha }}\n‚Ä¢ Deployed by: ${{ github.actor }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Site",
                        "emoji": true
                      },
                      "url": "https://inglesexpress.com"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Deployment",
                        "emoji": true
                      },
                      "url": "https://vercel.com/inglesexpress"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify deployment failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå Production deployment failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå Production Deployment Failed*\n\n‚Ä¢ Version: ${{ steps.version.outputs.VERSION }}\n‚Ä¢ Environment: production\n‚Ä¢ Commit: ${{ github.sha }}\n‚Ä¢ Deployed by: ${{ github.actor }}\n‚Ä¢ Workflow: ${{ github.workflow }}\n‚Ä¢ Run ID: ${{ github.run_id }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs",
                        "emoji": true
                      },
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
